<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
    <link href="//cdn.datatables.net/v/dt/jq-3.6.0/dt-1.13.4/af-2.5.3/cr-1.6.2/fc-4.2.2/fh-3.3.2/r-2.4.1/datatables.min.css" rel="stylesheet"/>
    <script src="//cdn.datatables.net/v/dt/jq-3.6.0/dt-1.13.4/af-2.5.3/cr-1.6.2/fc-4.2.2/fh-3.3.2/r-2.4.1/datatables.min.js"></script>
    <script src="//cdn.datatables.net/plug-ins/1.13.4/dataRender/ellipsis.js"></script>
    <style>
    body {
      margin: 1em;
    }
    #table1 {
      width:100%;
      padding-top: 1em;
    }
    #table1_filter {
      float: left;
      display: none;
    }
    #table1_length {
      float: right;
    }
    .dataTables_paginate {
      float: left;
    }
    table.dataTable thead th {
      font-size: 0.8em;
    }
    tfoot {
      display: table-header-group;
    }
    tfoot input {
      width: 100%;
      padding: 3px;
      box-sizing: border-box;
    }
    table tbody {
      font-family: monospace;
      font-size: 10pt;
    }
    .dataTables_length {
      padding-top: 0.34em;
    }
    .dataTables_wrapper .dataTables_paginate {
      padding-top: 0em;
    }
    .dataTables_wrapper .dataTables_info {
      padding-top: 0em;
    }

    table.dataTable td {
      text-align: center;
    }
    table.dataTable thead th {
      text-align: center;
    }
    table.dataTable tfoot tr th p {
      margin: 1px;
    }
    table.dataTable tfoot th, table.dataTable tfoot td {
      padding: 1px;
    }

    /* https://simurai.com/blog/2011/07/26/webkit-scrollbar */
    .dataTables_scrollBody::-webkit-scrollbar {
      -webkit-appearance: none;
      width: 1px;
    }
    .dataTables_scrollBody::-webkit-scrollbar-thumb {
      border-radius: 1px;
      background-color: rgba(0,0,0,.5);
      box-shadow: 0 0 1px rgba(255,255,255,.5);
    }

    /* https://stackoverflow.com/a/63507769 */
    #table1 {
      transform: rotateX(180deg);
      overflow-x: auto;
    } 
    .dataTables_scrollBody {
      transform: rotateX(180deg);
    }
  </style>
</head>
<body>
  <p>To execute any search, press enter key. Shift+click to sort on multiple columns.</p>

  <div id="showHideColumns" style="float:right;display:inline-block;margin-right:1em">
    <span id="showAllColumns" style="display:none">
      <button onclick="showAllColumns('#table1')">Show All Columns</button>
    </span>
    <span id="hideEmptyColumns" style="display:none">
        <button onclick="hideEmptyColumns('#table1')">Hide Empty Columns</button>
    </span>
    <span id="clearAllFilters" style="display:none">
      <button onclick="clearAllFilters('#table1')">Clear All Filters</button>
  </span>
</div>
  <table id="table1" class="display" style="width:100%"></table>
  <script>

    function showAllColumns(tableid) {
      $("#showAllColumns button").append(" ... processing");
      setTimeout(() => {
        let texto = $("#showAllColumns").text();
        $("#showAllColumns button").text(texto.replace(" ... processing", ""));
        let table = $(tableid).DataTable();
        table.columns().visible(true);
        $("#hideEmptyColumns").show();
        $("#showAllColumns").hide();
      },0)
    }

    function hideEmptyColumns(tableid) {
      let data = $(tableid).DataTable().data();
      let columnEmpty = [];
      for (let r = 0; r < data.length; r++) {
        for (let c = 0; c < data[r].length; c++) {
          if (r == 0) {
            columnEmpty.push(true);
          }
          if (data[r][c] !== null && data[r][c] !== "") {
            columnEmpty[c] = false;
          }
        }
      }
      let emptyColumns = [];
      let n = 0;
      for (let c = 0; c < columnEmpty.length; c++) {
        if (columnEmpty[c] === true) {
          n = n+1;
          emptyColumns.push(c);
        }
      }
      $(tableid).DataTable().columns(emptyColumns).visible(false);
      if (n > 0) {
        $("#showAllColumns").show();
        $("#hideEmptyColumns").hide();
      }
    }

    function clearAllFilters(tableid) {
      $('input').each(function (idx, el) {$(el).val('')});
      $(tableid).DataTable().search('').columns().search('').draw();
    }

    $(document).ready(function () {

      init();

      // Could do this before document.ready
      async function getHeader() {
        let resp = await fetch(window.location.href + "header");
        const header = await resp.json();
        return header;
      }

      async function getConfig(header) {

        let resp = await fetch(window.location.href + "config");
        const cfgo = await resp.json();

        columnDefs = [];
        searchCols = [];
        for (let i = 0; i < header.length; i++) {
          columnDefs.push({
            "name": header[i],
            "targets": i,
            "visible": true,
            //"render": DataTable.render.ellipsis( 10 ) // ellipsis.js plug-in
        });
          searchCols.push(null);
        }

        // https://datatables.net/reference/option/
        let cfg = {
          "serverSide": false,
          "deferRender": true,
          "stateSave": true,
          "lengthMenu": [ [50, 100, 500, 1000, -1], [50, 100, 500, 1000, "All"] ],
          "processing": true,
          "lengthChange": true,
          "scrollX": true,
          "scrollY": true,
          "autoWidth": true,
          "fixedHeader": true,
          "fixedColumns": true,
          "search": {
            "regex": true,
            "smart": false,
            "return": true // If true, must hit return key to invoke search
          },
          "columnDefs": columnDefs,
          "searchCols": searchCols,
        };
        cfg = {...cfg, ...cfgo};

        if (cfg['serverSide']) {
          cfg['ajax'] = {
            "url": window.location.href + "data/",
            "type": "get",
            "data": function(dtp) {
              for (let c = 0; c < dtp.columns.length; c++) {
                let name = dtp.columns[c]['name'];
                let searchValue = dtp.columns[c].search.value;
                if (searchValue) {
                  dtp["_" + name] = searchValue;
                }
              }
              orders = [];
              for (let i = 0; i < dtp.order.length; i++) {
                let  c = dtp.order[i].column;
                let name = dtp.columns[c]['name'];
                orders.push(dtp.order[i]['dir'] == 'asc' ? name : '-' + name);
              }
              //dtp.orderby = names[dtp.order[0]['column']];
              dtp.orders = orders.join(",");
              if (dtp.search.value)
                dtp.globalsearch = dtp.search.value;
              delete dtp.columns;
              delete dtp.search;
              delete dtp.order;
              console.log(dtp)
              return dtp;
            }
          };
        } else {
          cfg['ajax'] = window.location.href + "data/";
        }
        return cfg;
      }

      async function init() {

        const header = await getHeader();
        const config = await getConfig(header);

        // Add header names to table. Two rows are added.
        // The first row is for sorting, second row is for filtering.
        $('#table1').append('<thead><tr></tr><tr></tr></thead>');
        let thead = $('#table1 > thead > tr');
        for (let i = 0; i < header.length; i++) {
          thead.append(`<th>${header[i]}</th>`);
        }
        // Create table body
        $('#table1').append('<tbody></tbody>');

        // Hide paging if only one page
        $("#table1").on('length.dt', function () {
          if ($("#table1").dataTable().api().page.info().pages == 1) {
            $("#table1_paginate").hide();
          } else {
            $("#table1_paginate").show();
          }
        });

        // https://datatables.net/reference/option/
        let dataTableOptions =
          {
            ...config,
            "initComplete": dtInitComplete,
          };

        //console.log(dataTableOptions);

        let table = $('#table1').DataTable(dataTableOptions);
        //new $.fn.dataTable.FixedColumns( table );

        function adjustDOM(table) {

          $("#table1")
            .on('draw.dt', function () {
              // Hide paging if only one page on draw event.
              if ($("#table1").dataTable().api().page.info().pages == 1) {
                $("#table1_paginate").hide();
              } else {
                $("#table1_paginate").show();
              }
            })
            .trigger('draw.dt');
            // trigger() above needed for initial load for b/c draw.dt not triggered.

          let input = $('#table1_filter input').attr('placeholder','Global search')
          $('#table1_filter label').replaceWith(input[0]);
          $('#table1_info').insertAfter('#table1_filter');
          $('#table1_paginate').insertAfter('#table1_filter');
          $('#dataTables_length').append('<br>');
          $('#showHideColumns').insertBefore('#table1_info');

          // A resize triggers left column header width
          // to match the width of the body columns.
          setTimeout(function() {$(window).resize()}, 0);

          // Make the added header search row fixed b/c the fixedColumns
          // plugin does not seem to "see" the added row.
          $("thead tr:eq(0) > th:eq(0)")
            .css('position', 'sticky')
            .css('left', '0px')
            .css('z-index', '1000000')
            .css('background-color', 'white');

          // Prevent double header on first column showing when
          // on initial scroll.
          //$('.dataTables_scroll thead th').css('z-index',-1);
        }

        function dtInitComplete() {

          adjustDOM(this);

          var numCols = $('#table1').DataTable().columns().nodes().length;
          var numColsVisible = $('#table1').DataTable().columns(':visible').nodes().length;

          if (numColsVisible == numCols) {
            $("#hideEmptyColumns").show();
            $('#showAllColumns').hide();
          } else {
            $("#hideEmptyColumns").hide();
            $('#showAllColumns').show();
          }

          this.api().columns().every( function () {

            //console.log(this.column().visible())
            var that = this;

            // Create the `select` element
            $("thead tr:eq(0) > th").eq(this.index()).html('');
            let input = $(`<input type="text" placeholder="Search col." style="max-width:5em"/>`);
            input
              .appendTo($("thead tr:eq(0) > th").eq(this.index()))
              .on("keydown", function() {
                if (!config["search"]["return"]) {
                  that.search($(this).val()).draw();
                  $('#clearAllFilters').show();
                } else {
                  var keycode = (event.keyCode ? event.keyCode : event.which);
                  if(keycode == '13'){
                    that.search($(this).val()).draw();
                    $('#clearAllFilters').show();
                  }
                }
              });
            // Restore state saved values
            var state = this.state.loaded();
            if (state) {
              var val = state.columns[this.index()];
              input.val(val.search.search);
            }

          });
        }
      }
    });
  </script>
</body>
